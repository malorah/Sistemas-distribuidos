-- procesamiento_incidentes.pig (Versión para depuración integral)

-- 1) Cargar los datos CSV
jams_raw = LOAD '/input/jams_*.csv' USING PigStorage(',')
    AS (
        docId:chararray,
        idJam:chararray,
        country:chararray,
        commune:chararray,
        streetName:chararray,
        streetEnd:chararray,
        speedKmh:double,
        length:int,
        timestamp_str:chararray,
        city:chararray
    );

-- 2) Filtrar la fila de cabecera (si existe)
jams_filtered = FILTER jams_raw BY docId != '_id';

-- 3) Limpiar el campo de timestamp (quitar la 'Z' final)
-- PRUEBA: Usar TRIM en lugar de REGEX_REPLACE para probar resolución de UDF
jams_clean_ts_str = FOREACH jams_filtered GENERATE
    docId AS docId,
    idJam AS idJam,
    country AS country,
    commune AS commune,
    streetName AS streetName,
    streetEnd AS streetEnd,
    speedKmh AS speedKmh,
    length AS length,
    TRIM(timestamp_str) AS ts_noz_str, -- CAMBIO: Usando TRIM para probar
    city AS city;

-- 4) Convertir el string de timestamp a un objeto datetime
jams_with_event_time = FOREACH jams_clean_ts_str GENERATE
    docId AS docId,
    idJam AS idJam,
    country AS country,
    commune AS commune,
    streetName AS streetName,
    streetEnd AS streetEnd,
    speedKmh AS speedKmh,
    length AS length,
    ToDate(ts_noz_str, 'yyyy-MM-ddTHH:mm:ss') AS event_timestamp,
    city AS city;

-- 5) Filtrar registros donde la conversión de fecha NO haya resultado en null
jams_valid_event_time = FILTER jams_with_event_time BY NOT IsNull(event_timestamp);

-- 6) Estandarizar nombres de campos de texto a minúsculas
jams_standardized = FOREACH jams_valid_event_time GENERATE
    LOWER(country)    AS country,
    LOWER(commune)    AS commune,
    LOWER(streetName) AS streetName,
    LOWER(streetEnd)  AS streetEnd,
    speedKmh          AS speedKmh,
    length            AS length,
    event_timestamp   AS event_timestamp,
    LOWER(city)       AS city;

-- 7) Clasificar el tipo de incidente según la velocidad
jams_classified = FOREACH jams_standardized GENERATE
    country           AS country,
    commune           AS commune,
    city              AS city,
    (speedKmh > 20.0 ? 'speeding' : 'normal') AS speedType,
    event_timestamp   AS event_timestamp;

-- 8) Conteo de incidentes agrupados por comuna
incidentes_por_comuna_grouped = GROUP jams_classified BY commune;
conteo_incidentes_por_comuna = FOREACH incidentes_por_comuna_grouped GENERATE
    group              AS comuna,
    COUNT(jams_classified) AS totalIncidentes;

STORE conteo_incidentes_por_comuna INTO '/output/incidentes_por_comuna' USING PigStorage(',');

-- 9) Conteo de incidentes agrupados por (comuna, tipo de velocidad)
incidentes_por_comuna_tipo_grouped = GROUP jams_classified BY (commune, speedType);
conteo_incidentes_por_comuna_tipo = FOREACH incidentes_por_comuna_tipo_grouped GENERATE
    FLATTEN(group)     AS (comuna, speedType),
    COUNT(jams_classified) AS totalIncidentes;

STORE conteo_incidentes_por_comuna_tipo INTO '/output/incidentes_por_comuna_y_tipo' USING PigStorage(',');